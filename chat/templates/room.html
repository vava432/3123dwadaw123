{% extends "base.html" %}

{% block content %}
<div class="chat-room">
    <header>
        <h1>–ö–æ–º–Ω–∞—Ç–∞: {{ room.name }}</h1>
        <div class="header-actions">
            <button onclick="copyRoomLink()" class="btn">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫—É</button>
            <a href="{{ url_for('dashboard') }}" class="btn">–ù–∞–∑–∞–¥</a>
        </div>
    </header>

    <div class="chat-container">
        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <button class="tab-button active" data-tab="chat">–ß–∞—Ç</button>
            <button class="tab-button" data-tab="files">–§–∞–π–ª—ã</button>
        </div>

        <!-- –ß–∞—Ç -->
        <div class="tab-content active" id="chat-tab">
            <div class="messages-container" id="messages-container">
                {% for message in messages %}
                <div class="message" data-id="{{ message.id }}">
                    <span class="username">{{ message.username }}:</span>
                    <span class="text">{{ message.message|safe }}</span>
                    <span class="timestamp">{{ message.timestamp }}</span>
                </div>
                {% endfor %}
            </div>

            <div class="message-input">
                <input type="text" id="message-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ...">
                <button id="send-button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>

        <!-- –§–∞–π–ª—ã -->
        <div class="tab-content" id="files-tab">
            <div class="files-section">
                <div class="file-upload-area" id="file-upload-area">
                    <div class="upload-icon">üìÅ</div>
                    <p>–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞ –∏–ª–∏</p>
                    <input type="file" id="file-input" multiple style="display: none;">
                    <button onclick="document.getElementById('file-input').click()" class="btn">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª—ã</button>
                    <div class="upload-info">–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 100MB</div>
                </div>

                <div class="files-list" id="files-list">
                    {% for file in files %}
                    <div class="file-item" data-file-id="{{ file.id }}">
                        <div class="file-icon">{{ get_file_icon(file.original_filename) }}</div>
                        <div class="file-info">
                            <div class="file-name">{{ file.original_filename }}</div>
                            <div class="file-details">
                                <span class="file-size">{{ format_file_size(file.file_size) }}</span>
                                <span class="file-uploader">–æ—Ç {{ file.username }}</span>
                                <span class="file-date">{{ file.upload_date }}</span>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button onclick="downloadFile({{ file.id }})" class="btn-small">üì•</button>
                            {% if file.user_id == session.user_id or room.created_by == session.user_id %}
                            <button onclick="deleteFile({{ file.id }})" class="btn-small delete">üóëÔ∏è</button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const roomLink = "{{ room.link }}";
let lastMessageId = {{ last_message_id }};
const currentUsername = "{{ session.username }}";
const currentUserId = {{ session.user_id }};
const roomCreatorId = {{ room.created_by }};

function copyRoomLink() {
    navigator.clipboard.writeText(roomLink)
        .then(() => alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞'))
        .catch(err => console.error('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è:', err));
}
</script>
<script src="{{ url_for('static', filename='js/chat.js') }}"></script>
<script src="{{ url_for('static', filename='js/files.js') }}"></script>
{% endblock %}